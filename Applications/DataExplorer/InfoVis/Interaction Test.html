<!DOCTYPE html>
<!--
This document serves as a draft to the functionality to set up interactively the
parameters of diagrams. It will be initialized using the present data sets using
their base data accessors to access present categories.
-->
<html>
	<head>
		<meta charset="utf-8"></meta>
		<title>Interaction Test</title>
		<style>
			body {
				margin: 0px;
			}

			div.group {
				display: table-cell;
				padding: 0.5em;
				background-color: beige;
			}

			div.outerGroup {
				padding-top: 0.5em;
				padding-bottom: 0.5em;
				border: 1px solid black;
			}

			div.innerGroup {
			}

			div.leafGroup {
				display: block;
				padding: 0.25em;
				margin-bottom: 0.25em;
				border: 1px solid rgba(0, 0, 0, 0.05);
			}
		</style>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
		<script type="text/javascript" src="./inheritance.js"></script>
		<script type="text/javascript" src="./history.js"></script>
		<script type="text/javascript">

			//################
			//### commands ###
			//################
			//#################################
			//### ObjectSetAttributeCommand ###
			//#################################
			ObjectSetAttributeCommand = function(object, attributeIdentifier, newValue){

				var instance = ObjectSetAttributeCommand.applyParentConstructorTo(this);

				this._object = object;
				this._attributeIdentifier = attributeIdentifier;
				this._newValue = newValue;
				this._oldValue = undefined;

				return instance;
			}
			ObjectSetAttributeCommand.extend(historyPattern.AbstractCommand);

			ObjectSetAttributeCommand.prototype._do = function(){

				// look up
				this._oldValue = this._object[this._attributeIdentifier];

				// assign
				this._object[this._attributeIdentifier] = this._newValue;
			}

			ObjectSetAttributeCommand.prototype._undo = function(){

				// assign
				this._object[this._attributeIdentifier] = this._oldValue;
			}

			//###############################
			//### ArrayPushElementCommand ###
			//###############################
			ArrayPushElementCommand = function(array, element){

				var instance = ArrayPushElementCommand.applyParentConstructorTo(this);

				this._array = array;
				this._element = element;

				return instance;
			}
			ArrayPushElementCommand.extend(historyPattern.AbstractCommand);

			ArrayPushElementCommand.prototype._do = function(){

				this._array.push(this._element);
			}

			ArrayPushElementCommand.prototype._undo = function(){

				this._array.pop();
			}

			//#################################
			//### ArrayRemoveElementCommand ###
			//#################################
			ArrayRemoveElementCommand = function(array, index){

				var instance = ArrayRemoveElementCommand.applyParentConstructorTo(this);

				this._array = array;
				this._index = index;
				this._removedElement = undefined;

				return instance;
			}
			ArrayRemoveElementCommand.extend(historyPattern.AbstractCommand);

			ArrayRemoveElementCommand.prototype._do = function(){
				//#######################
				//### helper variable ###
				//#######################
				var elementsPastIndex = [];

				//#######################
				//### private methods ###
				//#######################

				// @param this - currentCommand
				var hasValidIndex = function(){

					return this._index >= 0 && this._index < this._array.length;
				}

				// @param this - currentCommand
				var lastElementHasSpecifiedIndex = function(){

					return this._array.length - 1 == this._index;
				}

				// @param this - currentCommand
				var detachElementsPastIndex = function(){

					while(!lastElementHasSpecifiedIndex.call(this)){
						elementsPastIndex.unshift(this._array.pop());
					}
				}

				// @param this - currentCommand
				var attachDetachedElements = function(){

					while(elementsPastIndex.length > 0){
						this._array.push(elementsPastIndex.shift());
					}
				}

				//############
				//### main ###
				//############

				if(hasValidIndex.call(this)){

					detachElementsPastIndex.call(this);
					this._removedElement = this._array.pop();
					attachDetachedElements.call(this);
				}
				else{
					throw new Error("index out of bounds");
				}
			}

			ArrayRemoveElementCommand.prototype._undo = function(){

				//#######################
				//### helper variable ###
				//#######################
				var elementsPastIndex = [];

				//#######################
				//### private methods ###
				//#######################

				// @param this - currentCommand
				var pushingWouldResultOnSpecifiedIndex = function(){

					return this._array.length == this._index;
				}

				// @param this - currentCommand
				var detachElementsPastIndex = function(){

					while(!pushingWouldResultOnSpecifiedIndex.call(this)){
						elementsPastIndex.unshift(this._array.pop());
					}
				}

				// @param this - currentCommand
				var attachDetachedElements = function(){

					while(elementsPastIndex.length > 0){
						this._array.push(elementsPastIndex.shift());
					}
				}

				//############
				//### main ###
				//############

				detachElementsPastIndex.call(this);
				this._array.push(this._removedElement);
				attachDetachedElements.call(this);
			}

			//##############
			//### series ###
			//##############
			SeriesSelection = function(){

				this.name = "";
				this.dataSetIndex = 0;
				this.xAttributeIndex = 0;
				this.yAttributeIndex = 0;
				this.sortingAttribute = 0;
			}

			//#################
			//### variables ###
			//#################
			/**
			 * dataSetList = [
			 * 	{name: "data set 01", accessor: accessor01},
			 * 	{name: "data set 02", accessor: accessor02},
			 * 	...
			 * 	{name: "data set N", accessor: accessorN}
			 * ]
			 */
			var dataSetList = [];

			/**
			 * seriesList = [
			 * 	{
			 * 		name: "series 01",
			 * 		dataSetIndex: 0,
			 * 		xAttribute: "temperature",
			 * 		yAttribute: "humidity",
			 * 		sortingAttribute: "date_of_measurement"
			 * 	},
			 * 	...
			 * ]
			 */
			var seriesList = [];


			//###############
			//### methods ###
			//###############
			function onLoad(){

				var dummyAccessor = {
					at: function(){ return this; },
					meta: function(){ return this; },
					access: function(){ return ["date_of_measurement", "temperature", "humidity", "brightness"]; }
				};

				setUp(
					[
						{name: "data set 00", accessor: dummyAccessor},
						{name: "data set 01", accessor: dummyAccessor},
						{name: "data set 02", accessor: dummyAccessor},
						{name: "data set 03", accessor: dummyAccessor}
					]
				);
			}

			function setUp(_dataSetList){

				dataSetList = _dataSetList;
			}

			var nextSeriesIndex = 0;
			function createNewSeries(){

				// create list entry
				var series = new SeriesSelection();
				series.name = "series" + nextSeriesIndex.toString();
				nextSeriesIndex++;
				seriesList.push(series);

				// update
				updateSelectDataSeries();

				// select new element
				var DOMSelect = d3.select("#selectDataSeries")[0][0];
				DOMSelect.selectedIndex = seriesList.length-1;
				DOMSelect.dispatchEvent(new CustomEvent("change", { detail: {notCalledManually: true} }));
			}

			function updateSelectDataSeries(){

				var select = d3.select("#selectDataSeries").selectAll("option").data(seriesList);

				select.enter()
					.append("option");

				select.exit()
					.remove();

				// update
				select
					.text(
						function(s){
							return s.name;
						}
					);
			}

			// @param this - <select>
			function onChangeSelectDataSeries(){
				var self = this;

				var isValidOptionIndex = function(index){
					return (index >= 0) && (index < self.length);
				}

				//### main ###
				if(isValidOptionIndex(this.selectedIndex)){

					updateSelectDataSet();
				}
				else{
					d3.select("#seriesAttributeArea").selectAll("option")
						.remove();
				}


			}

			function getCurrentSeries(){

				var DOMSelect = d3.select("#selectDataSeries")[0][0];

				return DOMSelect[DOMSelect.selectedIndex].__data__;
			}

			function getCurrentDataSet(){

				var DOMSelect = d3.select("#selectDataSet")[0][0];

				return DOMSelect[DOMSelect.selectedIndex].__data__;
			}

			function updateSelectDataSet(){

				var series = getCurrentSeries();

				var select = d3.select("#selectDataSet");
				var options = select.selectAll("option").data(dataSetList);

				options.enter()
					.append("option");

				options.exit()
					.remove();

				// update
				options
					.text(
						function(dataSet){
							return dataSet.name;
						}
					);

				// select entry
				var DOMSelect = select[0][0];
				DOMSelect.selectedIndex = series.dataSetIndex;
				DOMSelect.dispatchEvent(new CustomEvent("change", { detail: {notCalledManually: true} }));
			}

			function selectSeries(index){

				// if index == -1 or other non existing index
					// deselect series
					// disable attribute selecting CustomEvents
					// clear attribute <select> areas
						// d3.select("#seriesAttributeArea").selectAll("option").remove();
				// else
					// select series accordingly
					// fill dataSetSelect
					// select dataSetAccording to series
					// fill attribute areas
			}

			// @param this - <select>
			function selectDataSet(e){

				// set attribute of series
				var series = getCurrentSeries();
				series.dataSetIndex = this.selectedIndex;


				// set default attributes on manual change
				var calledManually = !(e.detail.notCalledManually == true);
				if(calledManually){

					series.xAttributeIndex = 0;
					series.yAttributeIndex = 0;
					series.sortingAttributeIndex = 0;
				}

				// setUp attribute area
				updateSelectXAttribute();
				updateSelectYAttribute();
				updateSelectSortingAttribute();

			}

			function updateSelectXAttribute(){

				var series = getCurrentSeries();
				var dataSet = getCurrentDataSet();

				var categories = dataSet.accessor.at(0).meta("column").meta("column_element_name").access();

				var select = d3.select("#selectXAttribute");
				var options = select.selectAll("option").data(categories);

				options.enter()
					.append("option");

				options.exit()
					.remove();

				// update
				options
					.text(
						function(category){
							return category;
						}
					);

				// select entry
				var DOMSelect = select[0][0];
				DOMSelect.selectedIndex = series.xAttributeIndex;
				DOMSelect.dispatchEvent(new CustomEvent("change", { detail: {notCalledManually: true} }));
			}

			function updateSelectYAttribute(){

				var series = getCurrentSeries();
				var dataSet = getCurrentDataSet();

				var categories = dataSet.accessor.at(0).meta("column").meta("column_element_name").access();

				var select = d3.select("#selectYAttribute");
				var options = select.selectAll("option").data(categories);

				options.enter()
					.append("option");

				options.exit()
					.remove();

				// update
				options
					.text(
						function(category){
							return category;
						}
					);

				// select entry
				var DOMSelect = select[0][0];
				DOMSelect.selectedIndex = series.yAttributeIndex;
				DOMSelect.dispatchEvent(new CustomEvent("change", { detail: {notCalledManually: true} }));
			}

			function updateSelectSortingAttribute(){

				var series = getCurrentSeries();
				var dataSet = getCurrentDataSet();

				var categories = dataSet.accessor.at(0).meta("column").meta("column_element_name").access();

				var select = d3.select("#selectSortingAttribute");
				var options = select.selectAll("option").data(categories);

				options.enter()
					.append("option");

				options.exit()
					.remove();

				// update
				options
					.text(
						function(category){
							return category;
						}
					);

				// select entry
				var DOMSelect = select[0][0];
				DOMSelect.selectedIndex = series.sortingAttributeIndex;
				DOMSelect.dispatchEvent(new CustomEvent("change", { detail: {notCalledManually: true} }));
			}



			// @param this - <select>
			function selectXAttribute(){

				var series = getCurrentSeries();

				series.xAttributeIndex = this.selectedIndex;
			}

			// @param this - <select>
			function selectYAttribute(){

				var series = getCurrentSeries();

				series.yAttributeIndex = this.selectedIndex;
			}

			// @param this - <select>
			function selectSortingAttribute(){

				var series = getCurrentSeries();

				series.sortingAttributeIndex = this.selectedIndex;
			}

		</script>
	</head>
	<body onload="onLoad()">
		<div class="group outerGroup">
			<div class="group innerGroup" id="seriesArea" >
				<div class="group leafGroup">
					<div class="label">
						<label for="selectDataSeries">data series</label>
					</div>
					<div class="select">
						<select id="selectDataSeries" name="selectDataSeries" size="5" onchange="onChangeSelectDataSeries.apply(this,arguments);" ></select>
					</div>
				</div>
				<div class="group leafGroup">
					<div class="button">
						<button type="button" onclick="createNewSeries();">create new</button>
					</div>
					<div class="button">
						<button type="button" onclick="alert('dummy');">delete selected</button>
					</div>
				</div>
			</div>

			<div class="group outerGroup" id="seriesAttributeArea" >

				<div class="group innerGroup">
					<div class="group leafGroup">
						<div class="label">
							<label for"selectDataSet">data set</label>
						</div>
						<div class="select">
							<select id="selectDataSet" onchange="selectDataSet.apply(this, arguments);" ></select>
						</div>
					</div>
				</div>
				<div class="group outerGroup">
					<div class="group innerGroup">
						<div class="group leafGroup">
							<div class="label">
								<label for="selectXAttribute">x attribute</label>
							</div>
							<div class="select">
								<select id="selectXAttribute" onchange="selectXAttribute.apply(this, arguments);" ></select>
							</div>
						</div>
						<div class="group leafGroup">
							<div class="label">
								<label for="selectYAttribute">y attribute</label>
							</div>
							<div class="select">
								<select id="selectYAttribute" onchange="selectYAttribute.apply(this, arguments);" ></select>
							</div>
						</div>
						<div class="group leafGroup">
							<div class="label">
								<label for="selectSortingAttribute">sorting attribute</label>
							</div>
							<div class="select">
								<select id="selectSortingAttribute" onchange="selectSortingAttribute.apply(this, arguments);" ></select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<div class="button">
		<button type="button" onclick="alert('dummy');">apply</button>
	</div>
</html>

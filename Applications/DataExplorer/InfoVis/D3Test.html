<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"></meta>
		<title>D3Test</title>
		<style>
			svg {
				background-color: beige;
			}
			html{
				height: 100%;
			}
			body {
				height: 95%;	/*
						this is an emperical value, that fills the page
						almost completely and avoids scroll bars. (QTWebview)
						TODO: What is the reason?
						*/
			}
			/*svg {
				width: 100%;
				height: 100%;
			}*/
		</style>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
		<script type="text/javascript" src="./infovis.js"></script>
		<script type="text/javascript">

			var GATE_ANNOUNCEMENT_NAME = "gate";

			function onLoad(){

				removeMessageOfUnavailabilityOfJavaScript();

				var gate = window[GATE_ANNOUNCEMENT_NAME];
				if(gate != undefined){

					// connect slots
					gate.transferredData.connect(onTransferredData);
				}
				else{

					console.warn("'gate' is not present");
				}

				if(isD3Available()){

				//	window.testCanvas = new infovis.LineDiagram("#viz");
				}
			}

			function onTransferredData(values, metaDataRelation, baseDataIndices){

				window.factory = new infovis.DataAccessorFactory(values, metaDataRelation);
				window.baseDataIndices = baseDataIndices;
				window.testAccessor = factory.makeAccessorFrom(baseDataIndices);

				// TODO: select dimensions
				// TODO: select subset of data

				// TODO: create diagram object
			}

			function extractCategory(category, accessor) {
				var result;

				// accessor.forEach(functor, { iterator: new TopLevelIterator(), applyToArrayElements: true });
				var index = -1;
				var firstLineAccessor = accessor.at(0);

				firstLineAccessor.forEach(
					function(elementAccessor, descendingIndex){
						if(index == -1){
							var matched = elementAccessor.meta("name").access() == category;
							if(matched){
								index = descendingIndex[0];
							}
						}
					}
				);

				result = accessor.split().map(
					function(rowAccessor){
						return rowAccessor.at(index).access();
					}
				);

				return result;
			}

			function extractTestData(accessor){

				var xValues = extractCategory("TimestampMeasurement", accessor);
				var yValues = extractCategory("DevicesTemperaturedatalogger0mSingle_value15Min", accessor);

				return xValues.map(
					function(_, index){
						return {
							x: xValues[index],
							y: yValues[index]
						};
					}
				);
			}

			function onClick(){

				console.log("onclick dummy");
			}

		</script>
	</head>
	<body onload="onLoad()" onclick="onClick()">
		<div id="viz">
				<p id="javaScriptNotAvailableDummy">JavaScript was not available</p>
		</div>
	</body>
</html>
